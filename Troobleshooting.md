# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB
```
Ответ:
Получим информацию о выполняемых операциях:
db.currentOp()

Завершим операцию в соответствии с идентификатором операции:
db.killOp(opid)

Для решением проблемы с долгими (зависающими) запросами, необходимо построить (перестроить) соответтствующие индексы.
Проанализировать запрос и дать рекомендации программистам для его изменения, например производить выборку только по тем полям,
которые нам нужны.
Сортировать и лимитировать выборки (брасть столько записей, сколько нужно в данный момент).
Паралелить все распаралеленный запросы.
Если дело касается тразакций, то их надо сделать максимально короткими.
```
## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?
 ```
 Ответ:
 Есть две вероятный проблемы:
 1.
 Redis имеет встроенную защиту, позволяющую пользователям устанавливать максимальное ограничение на использование
 памяти, используя maxmemory параметр в файле конфигурации, чтобы установить ограничение на объем памяти, 
 который может использовать Redis. Если этот предел будет достигнут, Redis начнет отвечать ошибкой 
 на команды записи (но продолжит принимать команды только для чтения).
 2.
 Если в базе данных очень много ключей, срок действия которых истекает в одну и ту же секунду, 
 и они составляют более 25% текущей совокупности ключей с установленным сроком действия , 
 Redis может зациклиться, чтобы получить значение ниже 25%.
 ```
## Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?
```
Ответ:
Скорее всего проблема из-за возрошего количества соединений, которые заданы параметром max_connections
Для решения проблемы, можно пропробовать увеличить значение параметра max_connections
Так же можно поэксперементировать со значениями: connect_timeout, interactive_timeout, wait_timeout - в сторону увеличения
```
## Задача 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

```
Ответ:
Linux не может выделить процессу оперативной памяти из-за того что она закончилась.
И тут у ядра 2 варианта, обрушить всю систему или завершить процесс, который съедает память.
Система всегда выбирает второй вариант ( вызывается OOM Killer) для для спасения ОС от аварийного завершения.
Решением проблемы может стать увеличение ОЗУ сервера.
Так же нужно отрегулировать значения параметров: max_connections, shared_buffer, work_mem, effective_cache_size, 
maintenance_work_mem

```
